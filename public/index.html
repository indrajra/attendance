<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>QR Scanner</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css"
        rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <!-- header  -->
    <section>
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#"><img src="./logo.png" alt="logo"></a>
                <button class="btn btn-outline-light my-2 my-sm-0" id="writeToCsv">Write Attendance</button>
            </div>
        </nav>
    </section>

    <!-- Scanner Section -->
    <section>
        <div class="container mt-lg-4">
            <div class="row mb-4">
                <div class="col-sm-12">
                    <input type="checkbox" id="toggle-event" checked data-toggle="toggle" data-on="Online"
                        data-off="Offline" data-style="btn-style" data-onstyle="secondary"
                        data-offstyle="outline-secondary" data-size="sm">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-muted">Scan The QRcode:</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-12">
                                    <b>Device has camera: </b>
                                    <span id="cam-has-camera"></span>
                                    <br>
                                    <div class="text-center">
                                        <video muted playsinline id="qr-video" width="320" height="240"></video>
                                    </div>
                                </div>
                            </div>

                            <hr data-content="OR" class="hr-text">
                            <div class="row" id="enterEmpCodeSec">
                                <div class="col-sm-12">
                                    <b>Enter Employee Code : </b>
                                    <form class="form-inline justify-content-center mt-3 needs-validation"
                                        id="employeeCodeForm">
                                        <div class="form-group mr-2">
                                            <label for="employeeCode" class="sr-only">Employee Code</label>
                                            <input type="text" class="form-control" id="employeeCode"
                                                placeholder="Employee Code" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Sumbit</button>
                                    </form>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <!-- profile card -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow mb-4" id="profile">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-muted">Mark Attendance</h6>
                        </div>
                        <div class="card-body text-center">
                            <img class="img-circle" id="#profileUrl"
                                src="http://ssl.gstatic.com/accounts/ui/avatar_2x.png">
                            <h4 id="empName"></h4>
                            <p>Employee Code : <span id="empCode"></span></p>
                            <p>Active : <span id="isActive"></span></p>
                            <button type="button" class="btn btn-success mr-4" id="markAttendance">Allow</button>
                            <button type="button" class="btn btn-outline-danger" id="deny">Deny</button>

                        </div>
                    </div>

                    <div class="card shadow mb-4" id="errorCard">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-muted">Error</h6>
                        </div>
                        <div class="card-body">
                            <b>Error msg: </b>
                            <span id="errorMsg">None</span>
                        </div>
                    </div>

                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-muted">Profile Detected</h6>
                        </div>
                        <div class="card-body">
                            <b>Detected QR code: </b>
                            <span id="cam-qr-result">None</span>
                            <br>
                            <b>Last detected at: </b>
                            <span id="cam-qr-result-timestamp"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="./jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

    <script type="module">


        import QrScanner from "./qr-scanner.min.js";
        QrScanner.WORKER_PATH = './qr-scanner-worker.min.js';

        $('#profile').hide();
        $('#errorCard').hide();
        const video = document.getElementById('qr-video');
        const camHasCamera = document.getElementById('cam-has-camera');
        const camQrResult = document.getElementById('cam-qr-result');
        const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
        const errorMsg = document.getElementById("errorMsg");
        const qrScannerEnable = true;
        var scanner;
        var fetchUserData;
        var toggleValue = $("input[type='checkbox']").is(":checked")

        function processQRdata(qrData) {
            console.log("scanned qr data", qrData);
            var reqBody = {
                request: JSON.parse(qrData)
            }
            $.ajax({
                url: "http://localhost:7007/attendance/registry/fetchUser",
                type: "post",
                dataType: "application/json",
                data: JSON.stringify(reqBody),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    console.log("Response", response);
                    if (response.recordVerified) {
                        fetchUserData = response;
                        viewProfile(fetchUserData)
                    } else {
                        viewErrorCard(response)
                        enableScanning()
                    }
                },
                error: function (error) {
                    console.log("err in fetching data", error.responseJSON);
                    viewErrorCard({ errMsg: error.statusText + " : please try again later" })
                    enableScanning()
                },
            });
        }

        //to show error messages
        function viewErrorCard(data) {
            errorMsg.textContent = data.errMsg
            $('#errorCard').show().delay(3000).hide(0);
        }

        function viewProfile(profileData) {
            $('#profile').show();
            $("#empName").text(profileData.name);
            $("#empCode").text(profileData.empCode);
            $("#isActive").text(profileData.isActive);
            if (profileData.profileUrl) {
                $("#profileUrl").attr("src", profileData.profileUrl)
            }
        }

        function markAttendance() {
            console.log("mark attendance", fetchUserData)
            var reqBody = {
                request: fetchUserData
            }
            $.ajax({
                url: "http://localhost:7007/attendance/mark",
                type: "post",
                dataType: "application/json",
                data: JSON.stringify(reqBody),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    console.log("markAttendance Response", response);
                    if (response) {
                        diableProfile();
                        enableScanning();
                    }
                }
            });

        }

        function offLineProcess(qrData) {
            let data = JSON.parse(qrData);
            data['osid'] = data.profile.substr(data.profile.lastIndexOf('/') + 1)
            data['orgName'] = ''
            fetchUserData = data;
            viewProfile(data);
        }

        function setResult(label, result) {
            label.textContent = result;
            if (result) {
                disableScanning();
                if (toggleValue) {
                    processQRdata(result); //online
                } else {
                    offLineProcess(result); //offline
                }
            }
            camQrResultTimestamp.textContent = new Date().toString();
            label.style.color = 'teal';
            clearTimeout(label.highlightTimeout);
            label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
        }

        // ####### Web Cam Scanning #######

        QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);
        enableScanning();

        //to diable the cammera
        function disableScanning() {
            scanner.destroy();
            scanner = null;
        }

        function enableScanning() {
            scanner = new QrScanner(video, result => setResult(camQrResult, result));
            scanner.start();
            scanner.setInversionMode("both");
        }

        function diableProfile() {
            $('#profile').hide();
            camQrResultTimestamp.textContent = ''
            camQrResult.textContent = 'none'
        }

        $("#employeeCodeForm").submit(function (event) {
            event.preventDefault()
            setResult(camQrResult, JSON.stringify({ empCode: document.getElementById("employeeCode").value }))
        })

        //on click of allow button
        $("#markAttendance").click(function () {
            markAttendance();
        });

        //on click of deny button: hide profile card
        $("#deny").click(function () {
            diableProfile();
        });

        $("#writeToCsv").click(function () {
            var reqBody = {}
            $.ajax({
                url: "http://localhost:7007/update/csv",
                type: "post",
                dataType: "application/json",
                data: reqBody,
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    console.log("Response", response);
                }
            });
        })


        $("input#toggle-event").change(function (event) {
            toggleValue = $("input[type='checkbox']").is(":checked");
            if (toggleValue) {
                $("hr").show()
                $('#enterEmpCodeSec').show();
            } else {
                $('#enterEmpCodeSec').hide();
                $("hr").hide();
            }
        })


    </script>
</body>

</html>