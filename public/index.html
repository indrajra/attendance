<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>QR Scanner Demo</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <!-- header  -->
    <section>
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#"><img src="./logo.png" alt="logo"></a>
            </div>
        </nav>
    </section>

    <!-- Scanner Section -->
    <section>
        <div class="container mt-lg-5">
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Scan The QRcode:</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-12">
                                    <b>Device has camera: </b>
                                    <span id="cam-has-camera"></span>
                                    <br>
                                    <div class="text-center">
                                        <video muted playsinline id="qr-video" width="320" height="240"></video>
                                    </div>
                                </div>
                            </div>

                            <hr data-content="OR" class="hr-text">
                            <div class="row">
                                <div class="col-sm-12">
                                    <b>Enter Employee Code : </b>
                                    <form class="form-inline justify-content-center mt-3 needs-validation"
                                        id="employeeCodeForm">
                                        <div class="form-group mr-2">
                                            <label for="employeeCode" class="sr-only">Employee Code</label>
                                            <input type="text" class="form-control" id="employeeCode"
                                                placeholder="Employee Code" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Sumbit</button>
                                    </form>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card shadow mb-4" id="profile">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Mark Attendance</h6>
                        </div>
                        <div class="card-body text-center">
                            <img class="img-circle" src="http://ssl.gstatic.com/accounts/ui/avatar_2x.png">
                            <h4 id="empName"></h4>
                            <p>Employee Code : <span id="empCode"></span></p>
                            <p>Active : <span id="isActive"></span></p>
                            <button type="button" class="btn btn-success mr-4" id="markAttendance">Allow</button>
                            <button type="button" class="btn btn-outline-danger" id="deny">Deny</button>

                        </div>
                    </div>
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Profile Detected</h6>
                        </div>
                        <div class="card-body">
                            <b>Detected QR code: </b>
                            <span id="cam-qr-result">None</span>
                            <br>
                            <b>Last detected at: </b>
                            <span id="cam-qr-result-timestamp"></span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="module">


        import QrScanner from "./qr-scanner.min.js";
        QrScanner.WORKER_PATH = './qr-scanner-worker.min.js';

        $('#profile').hide();
        const video = document.getElementById('qr-video');
        const camHasCamera = document.getElementById('cam-has-camera');
        const camQrResult = document.getElementById('cam-qr-result');
        const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
        const fileSelector = document.getElementById('employeeCode');
        const fileQrResult = document.getElementById('file-qr-result');
        const qrScannerEnable = true;
        var scanner;
        var fetchUserData;

        function processQRdata(qrData) {
            console.log("scanned qr data", qrData);
            var reqBody = {
                request: JSON.parse(qrData)
            }
            $.ajax({
                url: "http://localhost:7007/attendance/registry/fetchUser",
                type: "post",
                dataType: "application/json",
                data: JSON.stringify(reqBody),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    console.log("Response", response);
                    if (response.recordVerified) {
                        fetchUserData = response;
                        viewProfile(fetchUserData)
                    } else {
                        enableScanning()
                    }
                }
            });

            // FIXME: Hit registry and get details.
            // isActive must be true - controls deny or allow button.
        }

        function viewProfile(profileData) {
            $('#profile').show();
            $("#empName").text(profileData.name);
            $("#empCode").text(profileData.empCode);
            $("#isActive").text(profileData.isActive);
            //display photograph
        }

        function markAttendance() {
            console.log("mark attendance", fetchUserData)
            var reqBody = {
                request: fetchUserData
            }
            $.ajax({
                url: "http://localhost:7007/attendance/mark",
                type: "post",
                dataType: "application/json",
                data: JSON.stringify(reqBody),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    console.log("markAttendance Response", response);
                    if (response) {
                        diableProfile();
                        enableScanning();
                    }
                }
            });

        }

        function setResult(label, result) {
            label.textContent = result;
            if (result) {
                disableScanning();
                processQRdata(result);
            }
            camQrResultTimestamp.textContent = new Date().toString();
            label.style.color = 'teal';
            clearTimeout(label.highlightTimeout);
            label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
        }

        // ####### Web Cam Scanning #######

        QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);
        enableScanning();

        //to diable the cammera
        function disableScanning() {
            scanner.destroy();
            scanner = null;
        }

        function enableScanning() {
            scanner = new QrScanner(video, result => setResult(camQrResult, result));
            scanner.start();
            scanner.setInversionMode("both");
        }

        function diableProfile() {
            $('#profile').hide();
            camQrResultTimestamp.textContent = ''
            camQrResult.textContent = 'none'
        }

        $("#employeeCodeForm").submit(function (event) {
            event.preventDefault()
            setResult(camQrResult, JSON.stringify({ empCode: document.getElementById("employeeCode").value }))
        })

        //on click of allow button
        $("#markAttendance").click(function () {
            markAttendance();
        });

        //on click of deny button: hide profile card
        $("#deny").click(function () {
            diableProfile();
        });


    </script>
</body>

</html>