<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>QR Scanner</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css"
        rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <!-- header  -->
    <section>
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark justify-content-between">
            <div class="container">
                <a class="navbar-brand" href="#"><img src="./logo.png" alt="logo"></a>
                <div>
                    <button class="btn btn-outline-warning my-2 my-sm-1" id="stopCam">Stop cam</button>
                </div>
            </div>
        </nav>
    </section>

    <!-- Scanner Section -->
    <section>
        <div class="container mt-lg-4">
            <div class="row mb-4">
                <div class="col-sm-12">
                    <input type="checkbox" id="toggle-event" checked data-toggle="toggle" data-on="Online"
                        data-off="Offline" data-style="btn-primary" data-onstyle="primary" data-offstyle="secondary"
                        data-size="sm">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12" style="padding: 0 16rem 0 16rem;">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-muted">Scan QR</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-12">
                                    <h10>Device has camera: </h10>
                                    <span id="cam-has-camera"></span>
                                    <br>
                                    <div class="text-center">
                                        <video muted playsinline id="qr-video" width="320" height="240"
                                            style="margin-bottom:-10px"></video>
                                    </div>
                                </div>
                            </div>
                            <hr data-content="OR" class="hr-text">
                            <div class="row" id="enterEmpCodeSec">
                                <div class="col-sm-12 mb-4">
                                    <form class="form-inline justify-content-center mt-3 needs-validation"
                                        id="teacherCodeForm">
                                        <div class="form-group mr-2">
                                            <label for="teacherCodeInput" class="sr-only">Teacher Code</label>
                                            <input type="text" class="form-control" id="teacherCodeInput"
                                                placeholder="Enter Teacher Code" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </form>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4" style="display: none;">
                    <div class="card shadow">
                        <div class="card-header py-2">
                            <h6 class="m-0 font-weight-bold text-muted">Debug only</h6>
                        </div>
                        <div class="card-body">
                            <span class="small font-weight-bold">Detected QR: </span>
                            <span class="small" id="cam-qr-result">None</span> <br />
                            <span class="small font-weight-bold">Last detected at: </span>
                            <span class="small" id="cam-qr-result-timestamp"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal -->
    <div class="modal fade bd-example-modal-lg" id="offlineCourseModal" tabindex="-1" role="dialog"
        aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Offline Course Completion Detail</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center"> <img class="img-circle" id="#profileUrl"
                            src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/Circle-icons-profile.svg/1200px-Circle-icons-profile.svg.png">
                    </div>
                    <form id="teacherForm">
                        <div class="form-row">
                            <div class="col-md-8 mb-3">
                                <label for="teacherName">Name</label>
                                <input type="text" class="form-control" id="teacherName" placeholder="Name"
                                    name="teacherName" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="teacherCode">Code</label>
                                <input type="text" class="form-control" id="teacherCode" placeholder="Code"
                                    name="teacherCode" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6 mb-3">
                                <label for="courseName">Courses</label>
                                <select id="inputState" class="form-control" placeholder="select" required name="courseCode">
                                    <option value="" selected disabled>Select</option>
                                    <option value="COURSE01" >Java</option>
                                    <option value="COURSE02" >Angular</option>
                                    <option value="COURSE03" >React</option>
                                    <option value="COURSE04" >NodeJS</option>
                                    <option value="COURSE05" >C#</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="Marks">Marks</label>
                                <input type="text" class="form-control" id="marks" placeholder="marks" name="marks"
                                    required>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isCompleted" name="isCompleted">
                                <label class="form-check-label" for="isCompleted">
                                    isCompleted
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isTADAEligible" name="isTADAEligible">
                                <label class="form-check-label" for="isTADAEligible">
                                    isTADAEligible
                                </label>
                            </div>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="modalClose">Close</button>
                    <button class="btn btn-primary" type="submit" id="submitForm">Update Registry</button>
                </div>
                </form>
            </div>
        </div>
    </div>
    </div>

    <script src="./jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

    <script type="module">


        import QrScanner from "./qr-scanner.min.js";
        QrScanner.WORKER_PATH = './qr-scanner-worker.min.js';

        setProfile(); // show empty profile on load
        const video = document.getElementById('qr-video');
        const camHasCamera = document.getElementById('cam-has-camera');
        const camQrResult = document.getElementById('cam-qr-result');
        const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
        const errorMsg = document.getElementById("errorMsg");
        const qrScannerEnable = true;
        var scanner;
        var fetchUserData;
        var offlineCourses = []
        var toggleValue = $("input[type='checkbox']").is(":checked")
        //getOfflineCourses()

        function processQRdata(qrData) {
            console.log("scanned qr data", qrData);
            var reqBody = {
                request: JSON.parse(qrData)
            }
            $.ajax({
                url: "http://localhost:7007/attendance/registry/fetchUser",
                type: "post",
                dataType: "application/json",
                data: JSON.stringify(reqBody),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    console.log("Response", response);
                    if (response.recordVerified) {
                        fetchUserData = response;
                        setProfile(fetchUserData)
                    } else {
                        viewErrorCard(response)
                    }
                },
                error: function (error) {
                    var result = error.responseJSON || JSON.parse(error)
                    console.log("err in fetching data", result);
                    viewErrorCard(result)
                },
            });
        }

        //to show error messages
        function viewErrorCard(data) {
            alert("Error " + JSON.stringify(data))
            clearOldResult();
            startScanning()
            setProfile()
        }

        function setProfile(profileData) {
            if (profileData) {
                $("#teacherName").val(profileData.name)
                $("#teacherCode").val(profileData.code)
                if (profileData.profileUrl) {
                    $("#profileUrl").attr("src", profileData.profileUrl)
                }
                $('#offlineCourseModal').modal('show');
            } else {
                document.getElementById("teacherForm").reset();
                $("#profileUrl").attr("src", "https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/Circle-icons-profile.svg/1200px-Circle-icons-profile.svg.png")
            }
        }

        function updateCsv() {
            var reqBody = {
                request: fetchUserData
            }
            $.ajax({
                url: "http://localhost:7007/attendance/mark",
                type: "post",
                dataType: "application/json",
                data: JSON.stringify(reqBody),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    console.log("updateCsv Response", response);
                    if (response) {
                        clearOldResult();
                        startScanning();
                    }
                }
            });

        }

        function offLineProcess(qrData) {
            let data = JSON.parse(qrData);
            data['osid'] = data.profile.substr(data.profile.lastIndexOf('/') + 1)
            data['orgName'] = ''
            fetchUserData = data;
            setProfile(data);
        }

        function setResult(label, result) {
            label.textContent = result;
            if (result) {
                if (toggleValue) {
                    processQRdata(result); //online
                } else {
                    offLineProcess(result); //offline
                }
                camQrResultTimestamp.textContent = new Date().toString();
                label.style.color = 'teal';
                clearTimeout(label.highlightTimeout);
                label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
            }
        }

        // ####### Web Cam Scanning #######

        QrScanner.hasCamera().then(hasCamera => {
            createScanner();
            startScanning();
        });

        function stopScanning() {
            if (scanner) {
                scanner.stop();
            }
        }

        function createScanner() {
            scanner = new QrScanner(video, result => {
                if (result) {
                    stopScanning()
                    setResult(camQrResult, result)
                }
            });
            scanner.setInversionMode("both");
        }

        function startScanning() {
            if (scanner) {
                scanner.start();
            }
        }

        function clearOldResult() {
            camQrResultTimestamp.textContent = ''
            camQrResult.textContent = 'none'
            setProfile()
        }

        $("#teacherCodeForm").submit(function (event) {
            console.log("On submit of Teacher code form")
            event.preventDefault()
            setResult(camQrResult, JSON.stringify({ code: document.getElementById("teacherCodeInput").value }))
            document.getElementById("teacherCodeForm").reset()
        })

        $("#offlineCourseModal").on("hidden.bs.modal", function () {
            clearOldResult();
            startScanning();
        });

        $("#stopCam").click(function () {
            if (scanner) {
                if (scanner.isActive()) {
                    console.log("Stopped camera");
                    stopScanning()
                    $("#stopCam").html("Start Cam")
                    $("#stopCam").addClass("btn-primary")
                    $("#stopCam").removeClass("btn-outline-warning")
                } else {
                    startScanning()
                    $("#stopCam").html("Stop cam");
                    $("#stopCam").addClass("btn-outline-warning")
                    $("#stopCam").removeClass("btn-primary")

                }
            } else {
                alert("Camera not detected");
            }
        });

        $("#writeToCsv").click(function () {
            var reqBody = {}
            $.ajax({
                url: "http://localhost:7007/update/csv",
                type: "post",
                dataType: "application/json",
                data: reqBody,
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    console.log("Response", response);
                }
            });
        })


        $("input#toggle-event").change(function (event) {
            toggleValue = $("input[type='checkbox']").is(":checked");
            if (toggleValue) {
                $("hr").show()
                $('#enterEmpCodeSec').show();
            } else {
                $('#enterEmpCodeSec').hide();
                $("hr").hide();
            }
        })

        $("#teacherForm").submit(function (event) {
            event.preventDefault()
            var jsonData = {};
            $('#teacherForm').find('input[type=text],select').each(function () {
                jsonData[this.name] = this.value
            })
            jsonData['courseName'] = $("#inputState option:selected").text();
            jsonData['isCompleted'] = $('#isCompleted').is(":checked")
            jsonData['isTADAEligible'] = $('#isTADAEligible').is(":checked")
            $('#offlineCourseModal').modal('hide')
            fetchUserData = { ...jsonData, ...fetchUserData }
            updateCsv()
            document.getElementById("teacherForm").reset();
        });


        function getOfflineCourses() {
            $.ajax({
                url: "http://localhost:7007/offline/courses",
                type: "get",
                dataType: "application/json",
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    offlineCourses = response
                    if (offlineCourses.length > 0) {
                        $.each(offlineCourses, function (i, item) {
                            $('#inputState').append(new Option(item.courseName, item.courseCode))
                        })
                    }
                },
                error: function (error) {
                    var result = error.responseJSON || JSON.parse(error)
                    console.log("err in fetching data", result);
                    viewErrorCard(result)
                },
            });
        }

    </script>
</body>

</html>